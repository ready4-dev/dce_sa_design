---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    pandoc_args: 
      -  "--metadata-file=../Header/header_common.yaml"
      - '--lua-filter=../Filters/scholarly-metadata.lua'
      - '--lua-filter=../Filters/author-info-blocks.lua'
    toc: no
date: "`r format(Sys.Date(),'%d %B %Y')`"
subtitle: Pilot survey analysis sub-routine (replication)
params:
  eval_1L_lgl: True
  path_to_data_1L_chr: NULL
  X: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = params$eval_1L_lgl)
```

```{r child="../Child_RMDs/Copyright.Rmd", eval=TRUE}
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

# About this code

## Motivation
This sub-routine was used to analyse pilot survey responses for a Discrete Choice Experiment study that is currently being written up. Future versions of this program will include details of the parent study.

## Status
This code has been minimally adapted from when it was first applied. It has not been formatted for consistency or ease of use and a number of sections have copied almost unchanged from online examples provided by other authors to demonstrate the third party functions (in particular from the idefix package) used in this program. Future releases of this program aim to adopt a more consistent and integrated approach that should make the program easier to follow and adapt.

## Use
When using this code it is important to note that some of the steps in this program involve interactivity - they generate a prompt that a user must respond to before proceeding. Therefore, **this code should be run step by step** (i.e run one chunk at a time and do not try to run the program by knitting the R Markdown version of this code). Although it would be possible to add work-arounds to the interactivity issue, running the program by knitting the RMD version is still not recommended as it will prevent the documents generated by this program from rendering properly. 

# Install and load required libraries
If you do not already have the required libraries to run this program installed, you can do so by un-commenting and running the following lines.

```{r }
# utils::install.packages("idefix")
# utils::install.packages("magrittr")
# utils::install.packages("purrr")
# utils::install.packages("stringr")
# utils::install.packages("devtools")
# devtools::install_github("ready4-dev/ready4")
# devtools::install_github("ready4-dev/ready4use")
```

Next load the libraries required to run this program.

```{r message=FALSE, warning=FALSE}
library(magrittr)
library(ready4)
library(ready4use)
```

# Ingest data
Note the original data file has not been publicly distributed in order to protect participant confidentiality. Future releases will include access to a synthetic dataset that closely resembles the source data which will enable even those without access to the real data to execute this code.

```{r}
path_to_data_1L_chr <- "SUPPLY PATH TO DATASET HERE"
```

```{r echo=FALSE}
if(!is.null(params$path_to_data_1L_chr))
  path_to_data_1L_chr <- params$path_to_data_1L_chr
```

If a valid path has been supplied, the pilot survey response dataset can now be ingested.

```{r}
responses <- read.csv(path_to_data_1L_chr)
```

We can also retrieve details about the design of the pilot survey

```{r}
X <- Ready4useRepos(dv_nm_1L_chr = "springtolife", 
                    dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/VGPIPS", 
                    dv_server_1L_chr = "dataverse.harvard.edu")
pilot_design_repln_ls <- ingest(X,
                                fls_to_ingest_chr = "BBB_pilot_design_repln_ls",
                                metadata_1L_lgl = F)

```

# Analyse data
We can now produce the analysis of the pilot survey data. Note that the analysis algorithm involves random sampling so a seed must be set to make results reproducible. Also, for some random seeds NULL values will be generated that will prevent the analysis executing in full. Changing the random seed and rerunning the code will address this.

```{r}
set.seed(1985)
```

```{r}
n_responses <- nrow(responses)
choice_vars <- names(responses)[names(responses) %>% startsWith("DCE_B")] # Manually check order is correct
b1_vars <- choice_vars[choice_vars %>% startsWith("DCE_B1")]
b2_vars <- choice_vars[choice_vars %>% startsWith("DCE_B2")]
choice_responses <- responses %>% 
  dplyr::select(choice_vars) 
y <- purrr::map(1:n_responses, 
                ~ choice_responses %>% 
                  dplyr::slice(.x) %>% 
                  as.numeric() %>%
                  purrr::map(
                    ~ switch(.x,c(1,0,0),c(0,1,0),c(0,0,1))) %>% 
                  unlist()) %>%
  unlist()
blocks_vec <- purrr::map(1:n_responses, 
                        ~ choice_responses %>% 
                          dplyr::slice(.x) %>% 
                          as.numeric()) %>%
  purrr::map_chr(~ ifelse(all(is.na(c(.x)[1:15])),"Block_2","Block_1"))
des <- purrr::map(blocks_vec,
                   ~ pilot_design_repln_ls$pilot_survey_ls$design[switch("Block_1",
                                                                         "Block_1" = 1:45, 
                                                                         "Block_2" = 46:90),]) %>%
  stats::setNames(letters[1:7]) %>%
  purrr::reduce(~rbind(.x,.y))

## Constraints
low = c(-Inf, -Inf, -Inf, -Inf, -Inf, -Inf, -Inf, -Inf, -Inf, 0.005, 0.006, -Inf)
up = c(Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf, -0.0499)
pilot_analysis <- idefix::ImpsampMNL(n.draws = 100, 
                                     prior.mean = pilot_design_repln_ls$mu, 
                                     prior.covar = pilot_design_repln_ls$v, 
                                     des = des, 
                                     n.alts = 3, 
                                     y = y, 
                                     lower = low, 
                                     upper = up, 
                                     alt.cte = c(0,0,1))
```

# Share work
The final step is to share our non-confidential work outputs with others in an online repository. Note, you will need to supply your own repository details to run this part of the code successfully as you will not have write permissions to the repository `X` that we specify below.

```{r eval = FALSE}
Y <- share(X,
           obj_to_share_xx = pilot_analysis,
           fl_nm_1L_chr = "BBB_pilot_analysis_repln_ls",
           description_1L_chr = "List object to help replicate analysis of responses to pilot survey (output of dce_sa_design replication program)")
```


\elandscape
<!---BLOCK_LANDSCAPE_STOP--->

